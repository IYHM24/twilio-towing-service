# üìö Documentaci√≥n Completa del Proyecto - Twilio Towing Service

## üéØ Visi√≥n General

Este es un sistema completo de **API REST** para una empresa de gr√∫as que utiliza **Twilio** para:
- üì± Enviar mensajes SMS
- üìû Realizar llamadas telef√≥nicas automatizadas
- üéôÔ∏è Manejar un sistema IVR (Interactive Voice Response) completo
- üõ°Ô∏è Seguridad robusta con API Keys y rate limiting

---

## üìÅ Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ app.js                      # üèóÔ∏è Configuraci√≥n principal de Express
‚îú‚îÄ‚îÄ server.js                   # üöÄ Punto de entrada del servidor
‚îú‚îÄ‚îÄ swagger.json                # üìñ Documentaci√≥n de la API
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config.js              # ‚öôÔ∏è Configuraci√≥n de variables de entorno
‚îú‚îÄ‚îÄ controllers/               # üéÆ L√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ call.controller.js     # üìû Controlador de llamadas
‚îÇ   ‚îî‚îÄ‚îÄ sms.controller.js      # üì± Controlador de SMS
‚îú‚îÄ‚îÄ middlewares/               # üõ°Ô∏è Seguridad y validaciones
‚îÇ   ‚îú‚îÄ‚îÄ apikey.js             # üîë Autenticaci√≥n por API Key
‚îÇ   ‚îú‚îÄ‚îÄ logger.js             # üìù Logging de peticiones
‚îÇ   ‚îú‚îÄ‚îÄ rateLimiter.js        # üö¶ L√≠mite de peticiones
‚îÇ   ‚îú‚îÄ‚îÄ security.js           # üõ°Ô∏è Validaciones y CORS
‚îÇ   ‚îî‚îÄ‚îÄ simple-example.js     # üìö Ejemplos de middlewares
‚îú‚îÄ‚îÄ routes/                    # üõ£Ô∏è Definici√≥n de rutas
‚îÇ   ‚îú‚îÄ‚îÄ call.routes.js        # üìû Rutas de llamadas
‚îÇ   ‚îú‚îÄ‚îÄ sms.routes.js         # üì± Rutas de SMS
‚îÇ   ‚îî‚îÄ‚îÄ twiml.routes.js       # üéôÔ∏è Rutas del sistema IVR
‚îú‚îÄ‚îÄ services/                  # üîß L√≥gica de integraci√≥n con Twilio
‚îÇ   ‚îú‚îÄ‚îÄ outgoing.call.service.js  # üìû Servicio de llamadas
‚îÇ   ‚îî‚îÄ‚îÄ sms.service.js            # üì± Servicio de SMS
‚îî‚îÄ‚îÄ twiml/                     # üéôÔ∏è Sistema IVR completo
    ‚îú‚îÄ‚îÄ twiml.generator.js     # üè≠ Generador de respuestas TwiML
    ‚îú‚îÄ‚îÄ twiml.controller.js    # üéÆ Controlador del IVR
    ‚îú‚îÄ‚îÄ README.md              # üìñ Documentaci√≥n del IVR
    ‚îî‚îÄ‚îÄ templates/
        ‚îî‚îÄ‚îÄ towing.templates.js # üöõ Templates espec√≠ficos para gr√∫as
```

---

## üîß Componentes Principales

### 1. **üèóÔ∏è Configuraci√≥n Principal (`app.js`)**

```javascript
// Este archivo configura toda la aplicaci√≥n Express
const express = require('express');
const app = express();

// Middlewares de seguridad globales
app.use(helmet);              // Headers de seguridad HTTP
app.use(cors);                // Control de acceso entre dominios
app.use(apiRateLimit);        // L√≠mite de peticiones por IP
app.use(logger);              // Registro de todas las peticiones

// Middlewares de parsing
app.use(express.json());      // Parsear JSON en el body
app.use(express.urlencoded({ extended: true })); // Parsear formularios

// Rutas de la API
app.use('/sms', smsRoutes);    // Rutas de SMS
app.use('/call', callRoutes);  // Rutas de llamadas
app.use('/twiml', twimlRoutes); // Rutas del IVR

// Documentaci√≥n autom√°tica
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument));
```

**¬øQu√© hace?**
- Configura Express.js como servidor web
- Aplica middlewares de seguridad a todas las rutas
- Define las rutas principales de la API
- Configura la documentaci√≥n autom√°tica con Swagger

---

### 2. **‚öôÔ∏è Configuraci√≥n (`config/config.js`)**

```javascript
// Centraliza todas las variables de entorno
module.exports = {
  port: process.env.PORT || 3000,
  smsProviderApiKey: process.env.SMS_API_KEY || 'demo-key',
  twilio: {
    accountSid: process.env.TWILIO_ACCOUNT_SID,     // Tu SID de Twilio
    authToken: process.env.TWILIO_AUTH_TOKEN,       // Tu token de Twilio
    phoneNumber: process.env.TWILIO_PHONE_NUMBER    // Tu n√∫mero de Twilio
  }
};
```

**¬øQu√© hace?**
- Lee variables de entorno del archivo `.env`
- Proporciona valores por defecto para desarrollo
- Centraliza toda la configuraci√≥n en un solo lugar

---

### 3. **üõ°Ô∏è Middlewares de Seguridad**

#### **üîë Autenticaci√≥n (`middlewares/apikey.js`)**
```javascript
const apiKeyAuth = (req, res, next) => {
  const apiKey = req.headers['x-api-key'];
  if (apiKey && apiKey === config.smsProviderApiKey) {
    return next(); // ‚úÖ API Key v√°lida, continuar
  }
  return res.status(401).json({ error: 'ApiKey inv√°lida o faltante' });
};
```

**¬øQu√© hace?**
- Verifica que cada petici√≥n tenga un header `x-api-key`
- Compara la API key con la configurada en el servidor
- Bloquea peticiones sin API key v√°lida

#### **üö¶ Rate Limiting (`middlewares/rateLimiter.js`)**
```javascript
const smsRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 10, // m√°ximo 10 SMS por IP cada 15 minutos
  message: { error: 'Demasiadas peticiones de SMS' }
});
```

**¬øQu√© hace?**
- Limita el n√∫mero de peticiones por IP
- Previene spam y abuso del sistema
- Diferentes l√≠mites para SMS vs llamadas

#### **üõ°Ô∏è Validaciones (`middlewares/security.js`)**
```javascript
const validatePhoneNumber = (req, res, next) => {
  const { to } = req.body;
  const phoneRegex = /^\\+[1-9]\\d{1,14}$/; // Formato E.164
  if (!phoneRegex.test(to)) {
    return res.status(400).json({
      error: 'Formato de n√∫mero inv√°lido. Use formato E.164 (+1234567890)'
    });
  }
  next();
};
```

**¬øQu√© hace?**
- Valida que los n√∫meros de tel√©fono est√©n en formato internacional
- Verifica que los mensajes no est√©n vac√≠os o sean muy largos
- Sanitiza la entrada de datos

---

### 4. **üì± Servicio de SMS (`services/sms.service.js`)**

```javascript
const sendSms = async (to, message) => {
  try {
    // Usar el cliente de Twilio para enviar SMS
    const response = await client.messages.create({
      body: message,
      from: config.twilio.phoneNumber,
      to
    });
    
    return { 
      success: true, 
      sid: response.sid,    // ID √∫nico del mensaje
      status: response.status,
      to: response.to,
      from: response.from
    };
  } catch (error) {
    // Manejo espec√≠fico de errores de Twilio
    let errorMessage = error.message;
    
    if (error.code === 21408) {
      errorMessage = `Permisos no habilitados para enviar SMS a ${to}`;
    }
    // ... m√°s c√≥digos de error
    
    return { 
      success: false, 
      error: errorMessage,
      code: error.code
    };
  }
};
```

**¬øQu√© hace?**
- Se conecta a la API de Twilio para enviar SMS
- Maneja errores espec√≠ficos de Twilio con mensajes claros
- Retorna informaci√≥n detallada sobre el estado del env√≠o

---

### 5. **üìû Servicio de Llamadas (`services/outgoing.call.service.js`)**

```javascript
const makeCall = async (to, twimlUrl, options = {}) => {
  try {
    const callOptions = {
      to,                           // N√∫mero destino
      from: config.twilio.phoneNumber, // Tu n√∫mero de Twilio
      url: twimlUrl,               // URL con las instrucciones TwiML
      timeout: options.timeout || 60,
      record: options.record || false,
      statusCallback: options.statusCallback, // Webhook para updates
      ...options
    };

    const call = await client.calls.create(callOptions);
    
    return {
      success: true,
      callSid: call.sid,        // ID √∫nico de la llamada
      status: call.status,      // Estado inicial
      to: call.to,
      from: call.from
    };
  } catch (error) {
    // Manejo de errores espec√≠ficos de llamadas
    return {
      success: false,
      error: errorMessage,
      code: error.code
    };
  }
};
```

**¬øQu√© hace?**
- Inicia llamadas telef√≥nicas usando Twilio
- Configura opciones como grabaci√≥n, timeouts, webhooks
- Proporciona el estado en tiempo real de las llamadas

---

### 6. **üéôÔ∏è Sistema IVR - Generador TwiML (`twiml/twiml.generator.js`)**

```javascript
class TwiMLGenerator {
  // Genera mensaje simple de voz
  static generateSimpleMessage = (message, options = {}) => {
    const twiml = new VoiceResponse();
    
    twiml.say({
      voice: options.voice || 'alice',    // Voz del sistema
      language: options.language || 'es-MX' // Idioma
    }, message);
    
    twiml.hangup(); // Colgar despu√©s del mensaje
    return twiml.toString(); // Devolver XML
  };

  // Genera men√∫ interactivo
  static generateInteractiveMenu = (welcomeMessage, menuOptions = {}, options = {}) => {
    const twiml = new VoiceResponse();
    
    const gather = twiml.gather({
      timeout: options.timeout || 10,
      numDigits: options.numDigits || 1,
      action: options.action || '/twiml/main-menu', // Donde procesar la selecci√≥n
      method: 'POST'
    });
    
    gather.say({ voice: 'alice', language: 'es-MX' }, welcomeMessage);
    
    // Si no hay respuesta
    twiml.say({ voice: 'alice', language: 'es-MX' }, 
      'No recibimos ninguna respuesta. Gracias por llamar.');
    twiml.hangup();
    
    return twiml.toString();
  };
}
```

**¬øQu√© hace?**
- Genera XML en formato TwiML (lenguaje de Twilio)
- Crea diferentes tipos de respuestas: mensajes, men√∫s, grabaciones
- Maneja opciones de voz, idioma y comportamiento

---

### 7. **üöõ Templates para Gr√∫as (`twiml/templates/towing.templates.js`)**

```javascript
class TowingTemplates {
  // Men√∫ principal del sistema
  static welcomeMessage = (companyName = 'Brownsquare') => {
    const message = `Hola, gracias por contactar a ${companyName}. 
    Presione 1 para solicitar un servicio de gr√∫a.
    Presione 2 para consultar el estado de su servicio.
    Presione 3 para hablar con un operador.
    Presione 0 para repetir este men√∫.`;
    
    return TwiMLGenerator.generateInteractiveMenu(message, {}, {
      timeout: 15,
      numDigits: 1,
      action: '/twiml/main-menu' // Donde procesar la selecci√≥n
    });
  };

  // Solicitud de servicio con grabaci√≥n
  static requestService = () => {
    const message = `Ha seleccionado solicitar un servicio de gr√∫a.
    Por favor, despu√©s del tono, proporcione su ubicaci√≥n exacta, 
    el tipo de veh√≠culo y una descripci√≥n breve del problema.`;
    
    return TwiMLGenerator.generateRecordingPrompt(message, {
      timeout: 10,
      maxLength: 120, // 2 minutos m√°ximo
      action: '/twiml/service-request' // Donde procesar la grabaci√≥n
    });
  };
}
```

**¬øQu√© hace?**
- Define mensajes espec√≠ficos para empresa de gr√∫as
- Crea flujos de conversaci√≥n l√≥gicos
- Personaliza respuestas seg√∫n el contexto del negocio

---

### 8. **üéÆ Controlador IVR (`twiml/twiml.controller.js`)**

```javascript
class TwiMLController {
  // Maneja el men√∫ principal
  static mainMenu = (req, res) => {
    try {
      const companyName = process.env.COMPANY_NAME || 'Servicios de Gr√∫a Elite';
      const twiml = TowingTemplates.welcomeMessage(companyName);
      
      res.set('Content-Type', 'text/xml'); // Importante: XML, no JSON
      res.send(twiml);
    } catch (error) {
      const errorTwiml = TwiMLGenerator.generateErrorMessage();
      res.set('Content-Type', 'text/xml');
      res.send(errorTwiml);
    }
  };

  // Procesa la selecci√≥n del usuario
  static processMainMenu = (req, res) => {
    const { Digits } = req.body; // Twilio env√≠a el d√≠gito presionado
    let twiml = '';
    
    switch (Digits) {
      case '1': // Solicitar servicio
        twiml = TowingTemplates.requestService();
        break;
      case '2': // Consultar estado
        twiml = TowingTemplates.checkStatus();
        break;
      case '3': // Hablar con operador
        twiml = TowingTemplates.connectOperator(operatorNumber);
        break;
      default: // Opci√≥n inv√°lida
        twiml = TwiMLGenerator.generateSimpleMessage('Opci√≥n inv√°lida');
    }
    
    res.set('Content-Type', 'text/xml');
    res.send(twiml);
  };
}
```

**¬øQu√© hace?**
- Recibe peticiones de Twilio cuando el usuario interact√∫a
- Procesa las selecciones del men√∫ (1, 2, 3, etc.)
- Genera respuestas TwiML apropiadas
- Maneja errores y situaciones inesperadas

---

## üîÑ Flujo Completo de una Llamada

### **Paso 1: Iniciar Llamada**
```bash
POST /call/make
{
  "to": "+573001234567",
  "callType": "main-menu"
}
```

### **Paso 2: Tu servidor responde**
```javascript
// call.controller.js genera URL de TwiML
twimlUrl = "http://tu-servidor.com/twiml/main-menu"
// Twilio llama a esa URL
```

### **Paso 3: Twilio pide el TwiML**
```
GET http://tu-servidor.com/twiml/main-menu
```

### **Paso 4: Tu servidor responde con TwiML**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Gather timeout="15" numDigits="1" action="/twiml/main-menu" method="POST">
    <Say voice="alice" language="es-MX">
      Hola, gracias por contactar a Brownsquare...
    </Say>
  </Gather>
</Response>
```

### **Paso 5: Usuario presiona "1"**
```
POST http://tu-servidor.com/twiml/main-menu
Body: Digits=1
```

### **Paso 6: Tu servidor procesa y responde**
```javascript
// twiml.controller.js
case '1':
  twiml = TowingTemplates.requestService(); // Nuevo TwiML
```

### **Paso 7: El ciclo contin√∫a...**
Hasta que la llamada termine o se cuelgue.

---

## üõ°Ô∏è Seguridad Implementada

### **üîë Autenticaci√≥n**
- API Key en header `x-api-key`
- Endpoints protegidos vs p√∫blicos
- Validaci√≥n en cada petici√≥n

### **üö¶ Rate Limiting**
- SMS: 10 por 15 minutos por IP
- API general: 100 por 15 minutos por IP
- Previene spam y abuso

### **üõ°Ô∏è Validaciones**
- N√∫meros de tel√©fono en formato E.164
- Longitud de mensajes
- Sanitizaci√≥n de entrada
- Headers de seguridad (Helmet)
- CORS configurado

### **üìù Logging**
- Todas las peticiones registradas
- Errores detallados
- Estados de llamadas y SMS

---

## üéØ Tipos de Endpoints

### **üîí Protegidos (requieren API Key):**
- `POST /sms/send` - Enviar SMS
- `POST /call/make` - Realizar llamada
- `GET /call/status/{callSid}` - Estado de llamada
- `POST /call/hangup/{callSid}` - Terminar llamada

### **üåê P√∫blicos (sin autenticaci√≥n):**
- `GET/POST /twiml/*` - Respuestas IVR
- `POST /call/status-webhook` - Webhooks de Twilio
- `GET /api-docs` - Documentaci√≥n

---

## üìä Estados y C√≥digos

### **Estados de SMS:**
- `queued` - En cola para env√≠o
- `sent` - Enviado al operador
- `delivered` - Entregado al usuario
- `failed` - Fallo en el env√≠o

### **Estados de Llamadas:**
- `queued` - En cola
- `ringing` - Sonando
- `answered` - Contestada
- `completed` - Terminada
- `busy` - Ocupado
- `no-answer` - No contestaron

### **C√≥digos de Error Comunes:**
- `21408` - Permisos geogr√°ficos no habilitados
- `21211` - N√∫mero de tel√©fono inv√°lido
- `20003` - Credenciales de Twilio inv√°lidas

---

## üöÄ C√≥mo Ejecutar

### **1. Instalar dependencias:**
```bash
npm install
```

### **2. Configurar variables:**
```bash
cp .env.example .env
# Editar .env con tus credenciales de Twilio
```

### **3. Iniciar servidor:**
```bash
npm start
# o
node src/server.js
```

### **4. Ver documentaci√≥n:**
```
http://localhost:3000/api-docs
```

---

## üìö Recursos Adicionales

- **üìñ Documentaci√≥n Swagger:** `/api-docs`
- **üéôÔ∏è Documentaci√≥n IVR:** `src/twiml/README.md`
- **üìã Ejemplos de uso:** `EXAMPLES.md`
- **üß™ Middlewares de ejemplo:** `src/middlewares/simple-example.js`

---

## üéØ Conclusi√≥n

Este proyecto es una **API completa y profesional** que demuestra:

- ‚úÖ **Arquitectura limpia** con separaci√≥n de responsabilidades
- ‚úÖ **Seguridad robusta** con m√∫ltiples capas de protecci√≥n
- ‚úÖ **Manejo de errores** espec√≠fico para cada situaci√≥n
- ‚úÖ **Sistema IVR completo** con flujos de conversaci√≥n
- ‚úÖ **Documentaci√≥n autom√°tica** con Swagger
- ‚úÖ **C√≥digo mantenible** con arrow functions y buenas pr√°cticas
- ‚úÖ **Integraci√≥n completa** con Twilio para SMS y llamadas

¬°Es un ejemplo perfecto de c√≥mo construir una API moderna y escalable! üöÄ